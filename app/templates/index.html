<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Form Tester — Live</title>
<style>
  body{font-family:Inter,Segoe UI,Arial;margin:18px;background:#fafafa}
  input{width:480px;padding:8px;border:1px solid #ccc;border-radius:4px}
  button{padding:8px 12px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer}
  #progress_wrap{width:100%;height:18px;background:#eee;border-radius:12px;margin-top:14px;overflow:hidden}
  #bar{height:18px;background:#28a745;width:0;transition:width .3s}
  .timer{margin-top:8px;color:#444}
  .step{background:#fff;border:1px solid #e6e6e6;padding:8px;border-radius:6px;margin-top:8px}
  .ok{color:#28a745;font-weight:600}
  .error{color:#d93025;font-weight:600}
  img.preview{max-width:460px;border:1px solid #ddd;margin-top:6px;border-radius:4px}
  .meta{font-size:0.9rem;color:#666}
</style>
</head>
<body>
  <h1>Form Tester (Live)</h1>
  <div>
    <input id="url" placeholder="Enter full page URL (http/https)"/>
    <button id="start">Start Test</button>
  </div>

  <div id="progress_wrap"><div id="bar"></div></div>
  <div class="timer" id="timer">Elapsed: 0s | Remaining: 0s</div>

  <div id="steps"></div>
  <div id="screens"></div>

<script>
const startBtn = document.getElementById('start');
const urlBox = document.getElementById('url');
const bar = document.getElementById('bar');
const timer = document.getElementById('timer');
const stepsDiv = document.getElementById('steps');
const screensDiv = document.getElementById('screens');

let jobId = null;
let pollInterval = null;

startBtn.addEventListener('click', async () => {
  const url = urlBox.value.trim();
  if(!url) { alert('Enter a valid http(s) URL'); return; }
  stepsDiv.innerHTML = '<div class="meta">Starting job...</div>';
  screensDiv.innerHTML = '';
  try {
    const res = await fetch(`/run_template_async?url=${encodeURIComponent(url)}`);
    const data = await res.json();
    if(data.error){ alert('Server error: '+data.error); return; }
    jobId = data.job_id;
    bar.style.width = '2%';
    // start polling
    pollInterval = setInterval(checkStatus, 1000);
  } catch (e) {
    console.error(e); alert('Request failed: '+e.toString());
  }
});

async function checkStatus(){
  if(!jobId) return;
  try {
    const r = await fetch(`/job_status?job_id=${jobId}`);
    if(!r.ok){ console.error('status fetch failed', r.status); return; }
    const d = await r.json();
    if(!d || !d.job_id) return;

    // progress bar
    const progress = d.progress || 0;
    bar.style.width = progress + '%';

    // timer & eta
    timer.innerText = `Elapsed: ${d.elapsed || 0}s | Remaining: ${d.eta || 0}s`;

    // steps
    let html = `<h3>Status: ${d.result || 'RUNNING'}</h3>`;
    html += `<div class="meta">Job: ${d.job_id} • URL: ${d.url}</div>`;
    html += '<div style="margin-top:10px">';
    if(Array.isArray(d.steps)){
      d.steps.forEach(step=>{
        const cls = step.status && step.status.toString().toLowerCase().includes('ok') ? 'ok' :
                    step.status && step.status.toString().toLowerCase().includes('error') ? 'error' : '';
        const labelPart = step.label ? `<strong>${escapeHtml(step.label)}</strong> — ` : '';
        const fieldPart = step.field ? `<em>(${escapeHtml(step.field)})</em> ` : '';
        const valuePart = step.value ? `<code> ${escapeHtml(step.value)}</code>` : '';
        const errPart = step.error ? `<div style="color:#d93025;margin-top:6px">${escapeHtml(step.error)}</div>` : '';
        html += `<div class="step ${cls}">${labelPart}${escapeHtml(step.action)} ${fieldPart}${valuePart}${errPart}</div>`;
      });
    }
    html += '</div>';
    stepsDiv.innerHTML = html;

    // screenshots
    if(Array.isArray(d.artifacts) && d.artifacts.length){
      let scHtml = '<h4>Screenshots</h4>';
      d.artifacts.forEach(a=>{
        scHtml += `<div style="margin-top:10px"><a href="${a}" target="_blank">${a}</a><br><img class="preview" src="${a}"/></div>`;
      });
      screensDiv.innerHTML = scHtml;
    }

    if(progress >= 100){
      clearInterval(pollInterval);
      bar.style.width = '100%';
      // play small success chime if PASS
      if(d.result === 'PASS'){
        try { new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg').play(); } catch(e){}
      }
    }
  } catch (e) {
    console.error('checkStatus error', e);
  }
}

function escapeHtml(s){
  if(!s) return '';
  return s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
